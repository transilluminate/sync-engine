â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           sync-engine: Basic Usage Example                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ Configuring sync-engine...
2026-01-02T13:49:05.439887Z  INFO Creating expandable cuckoo filter manager node_id=sync-engine-l3 initial_capacity=100000
   State: Created

ğŸš€ Starting engine (connecting to backends)...
2026-01-02T13:49:05.442928Z  INFO start: Starting sync engine with trust-verified startup...
2026-01-02T13:49:05.443308Z  INFO start: Initializing write-ahead log path=./sync_engine_wal.db max_items=1000000 max_bytes=104857600
2026-01-02T13:49:05.451923Z  INFO start: Write-ahead log initialized path=./sync_engine_wal.db
2026-01-02T13:49:05.452749Z  INFO start: Connecting to SQL (L3 - ground truth)... url=mysql://test:test@localhost:3306/test
2026-01-02T13:49:05.573585Z  INFO start: SQL (L3) connected with merkle store (ground truth) has_sql=true
2026-01-02T13:49:05.575362Z  INFO start: SQL merkle root (ground truth) root=cf9b6d08191ade9a77b9e2d0256a2ce928fe87b75cb231d8ebd43666d92c41cb has_sql=true
2026-01-02T13:49:05.575780Z  INFO start: No L3 CF snapshot found - filter will be built on warmup has_sql=true
2026-01-02T13:49:05.575876Z  INFO start: Connecting to Redis (L2 - cache)... url=redis://localhost:6379 prefix=Some("sync:") has_sql=true
2026-01-02T13:49:05.578410Z  INFO start: Redis (L2) connected with merkle shadow tree has_sql=true has_redis=true
2026-01-02T13:49:05.579726Z  INFO start: Redis merkle tree is empty - will be populated on writes has_sql=true has_redis=true
2026-01-02T13:49:05.579813Z  INFO start: Sync engine ready (trust-verified startup complete) has_sql=true has_redis=true
   âœ… Engine ready! State: Ready

ğŸ“ Creating 5 sample entries...
   â±ï¸  Timing each .await() to showcase L1 cache speed
   â””â”€ Submitted: user.alice â†’ {"name":"Alice","role":"admin"} (160.041Âµs)
   â””â”€ Submitted: user.bob â†’ {"name":"Bob","role":"user"} (81.917Âµs)
   â””â”€ Submitted: user.carol â†’ {"name":"Carol","role":"user"} (60.125Âµs)
   â””â”€ Submitted: config.app â†’ {"theme":"dark","version":"2.0"} (62.917Âµs)
   â””â”€ Submitted: stats.daily â†’ {"latency_p99":12,"requests":42000} (58.875Âµs)
   âš¡ Submit avg: 84.775Âµs (L1 memory write, non-blocking)

â³ Flushing to backends... (waiting 100ms for async writes)
2026-01-02T13:49:05.627280Z  INFO Batch flush complete l2_success=5 l2_errors=0 l3_success=5 wal_fallback=0 groups=1 flush_ms=46 reason=Manual
   âœ… Flush complete!

ğŸ” Checking existence...
   â””â”€ contains_fast('user.alice'): true
   â””â”€ contains('user.alice'): true
   â””â”€ contains('user.nobody'): false

ğŸ“– Fetching entries back (with timing)...
   â±ï¸  These should hit L1 cache (microseconds!)
   â””â”€ user.alice (v1) â†’ {"name":"Alice","role":"admin"} (248.292Âµs)
   â””â”€ user.bob (v1) â†’ {"name":"Bob","role":"user"} (73.541Âµs)
   â””â”€ user.carol (v1) â†’ {"name":"Carol","role":"user"} (50Âµs)
   â””â”€ config.app (v1) â†’ {"theme":"dark","version":"2.0"} (45.834Âµs)
   â””â”€ stats.daily (v1) â†’ {"latency_p99":12,"requests":42000} (48.125Âµs)
   âš¡ Get avg: 93.158Âµs (L1 cache hit)

ğŸ“Š Engine Metrics:
   â”Œâ”€ L1 Cache (Memory)
   â”‚  â””â”€ Entries: 5
   â”‚  â””â”€ Size: 2045 bytes
   â”‚  â””â”€ Pressure: 0.0%
   â”œâ”€ L3 Cuckoo Filter (before verify)
   â”‚  â””â”€ Entries: 5/100000
   â”‚  â””â”€ Trust: Untrusted
   â”œâ”€ Merkle Trees
   â”‚  â””â”€ Redis (L2): e7df34b5708e4d9072e0ba58988fe8f15f91ea44aac74928253462db61567efe
   â”‚  â””â”€ SQL (L3):   e7df34b5708e4d9072e0ba58988fe8f15f91ea44aac74928253462db61567efe
   â”‚  â””â”€ âœ… Roots match! Data is in sync.

ğŸ” Verifying L3 filter against SQL merkle...
2026-01-02T13:49:05.754982Z  INFO Verifying L3 filter against SQL merkle root sql_root=e7df34b5708e4d9072e0ba58988fe8f15f91ea44aac74928253462db61567efe
2026-01-02T13:49:05.755031Z  INFO Marking cuckoo filter as trusted entries=5
   â””â”€ Verified: true â†’ Trust: Trusted

ğŸ“ Item Status:
   â””â”€ user.alice: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ user.bob: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ user.carol: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ config.app: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ stats.daily: Synced { in_l1: true, in_l2: true, in_l3: true }

ğŸ“ˆ Raw Metrics (OTEL export format):
   â”Œâ”€ Counters (cumulative)
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L1} = 156
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L2} = 156
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L3} = 156
   â”‚  â””â”€ sync_engine_cdc_entries_total{op=PUT} = 5
   â”‚  â””â”€ sync_engine_items_written_total{tier=L2} = 5
   â”‚  â””â”€ sync_engine_items_written_total{tier=L3} = 5
   â”‚  â””â”€ sync_engine_merkle_operations_total{store=redis,operation=batch_update,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L1,operation=submit,status=success} = 5
   â”‚  â””â”€ sync_engine_operations_total{tier=L2,operation=batch_write,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L3,operation=batch_write,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L1,operation=get,status=hit} = 5
   â”œâ”€ Gauges (current value)
   â”‚  â””â”€ sync_engine_backend_healthy{backend=mysql} = 1.00
   â”‚  â””â”€ sync_engine_backend_healthy{backend=redis} = 1.00
   â”‚  â””â”€ sync_engine_backpressure_level = 0.00
   â”‚  â””â”€ sync_engine_cuckoo_filter_entries{filter=L3} = 5.00
   â”‚  â””â”€ sync_engine_cuckoo_filter_load{filter=L3} = 0.00
   â”‚  â””â”€ sync_engine_l1_cache_bytes = 2045.00
   â”‚  â””â”€ sync_engine_l1_cache_items = 5.00
   â”‚  â””â”€ sync_engine_memory_pressure = 0.00
   â””â”€ Histograms (distributions)
   â”‚  â””â”€ sync_engine_batch_bytes{tier=L2}
   â”‚     count=1 sum=156.0000 avg=156.0000 min=156.0000 max=156.0000
   â”‚  â””â”€ sync_engine_batch_bytes{tier=L3}
   â”‚     count=1 sum=156.0000 avg=156.0000 min=156.0000 max=156.0000
   â”‚  â””â”€ sync_engine_batch_size{tier=L2}
   â”‚     count=1 sum=5.0000 avg=5.0000 min=5.0000 max=5.0000
   â”‚  â””â”€ sync_engine_batch_size{tier=L3}
   â”‚     count=1 sum=5.0000 avg=5.0000 min=5.0000 max=5.0000
   â”‚  â””â”€ sync_engine_flush_seconds
   â”‚     count=1 sum=0.0464 avg=0.0464 min=0.0464 max=0.0464
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L1,operation=submit}
   â”‚     count=5 sum=0.0002 avg=0.0000 min=0.0000 max=0.0001
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L2,operation=batch_write}
   â”‚     count=1 sum=0.0013 avg=0.0013 min=0.0013 max=0.0013
   â”‚  â””â”€ sync_engine_operation_seconds{tier=CDC,operation=put_batch}
   â”‚     count=1 sum=0.0006 avg=0.0006 min=0.0006 max=0.0006
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L3,operation=batch_write}
   â”‚     count=1 sum=0.0101 avg=0.0101 min=0.0101 max=0.0101
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L1,operation=get}
   â”‚     count=5 sum=0.0002 avg=0.0000 min=0.0000 max=0.0001
   â”‚  â””â”€ sync_engine_startup_seconds{phase=wal_init}
   â”‚     count=1 sum=0.0089 avg=0.0089 min=0.0089 max=0.0089
   â”‚  â””â”€ sync_engine_startup_seconds{phase=sql_connect}
   â”‚     count=1 sum=0.1208 avg=0.1208 min=0.1208 max=0.1208
   â”‚  â””â”€ sync_engine_startup_seconds{phase=cf_restore}
   â”‚     count=1 sum=0.0004 avg=0.0004 min=0.0004 max=0.0004
   â”‚  â””â”€ sync_engine_startup_seconds{phase=redis_connect}
   â”‚     count=1 sum=0.0025 avg=0.0025 min=0.0025 max=0.0025
   â”‚  â””â”€ sync_engine_startup_seconds{phase=redis_sync}
   â”‚     count=1 sum=0.0013 avg=0.0013 min=0.0013 max=0.0013
   â”‚  â””â”€ sync_engine_startup_total_seconds
   â”‚     count=1 sum=0.1369 avg=0.1369 min=0.1369 max=0.1369

ğŸ›‘ Shutting down...
2026-01-02T13:49:05.764235Z  INFO shutdown: Initiating sync engine shutdown...
2026-01-02T13:49:05.791488Z  INFO shutdown: Filter state saved filter_id="l3" entry_count=5 bytes=131108
2026-01-02T13:49:05.791527Z  INFO shutdown: Cuckoo filter snapshot saved (L3 only) reason="shutdown" inserts_since_last=5 l3_entries=5 merkle_root=e7df34b5708e4d9072e0ba58988fe8f15f91ea44aac74928253462db61567efe
2026-01-02T13:49:05.791566Z  INFO shutdown: Sync engine shutdown complete
   âœ… Shutdown complete! State: ShuttingDown

ğŸ§¹ Cleaning up WAL file...
   â””â”€ Removed: ./sync_engine_wal.db
   âœ… WAL cleanup complete!

ğŸ’¡ Data remains in Redis/MySQL - inspect with:
   â””â”€ Redis:  redis-cli JSON.GET sync:user.alice '$.payload'
   â””â”€ MySQL:  SELECT id, payload FROM sync_items;
   â””â”€ Query:  SELECT * FROM sync_items WHERE JSON_EXTRACT(payload, '$.name') = 'Alice';
   â””â”€ UIs:    http://localhost:5540 (RedisInsight)
              http://localhost:8080 (Adminer)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Example complete!                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
