â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           sync-engine: Basic Usage Example                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ Configuring sync-engine...
2025-12-31T11:38:01.870826Z  INFO Creating expandable cuckoo filter manager node_id=sync-engine-l3 initial_capacity=100000
   State: Created

ğŸš€ Starting engine (connecting to backends)...
2025-12-31T11:38:01.875017Z  INFO start: Starting sync engine with trust-verified startup...
2025-12-31T11:38:01.875280Z  INFO start: Initializing write-ahead log path=./sync_engine_wal.db max_items=1000000 max_bytes=104857600
2025-12-31T11:38:01.882818Z  INFO start: Write-ahead log initialized path=./sync_engine_wal.db
2025-12-31T11:38:01.884755Z  INFO start: Connecting to SQL (L3 - ground truth)... url=mysql://test:test@localhost:3306/test
2025-12-31T11:38:02.001608Z  INFO start: SQL (L3) connected with merkle store (ground truth) has_sql=true
2025-12-31T11:38:02.006426Z  INFO start: SQL merkle root (ground truth) root=49a817291df402642fe022a60c88e4c7b54937fe3624251e713c26c0fb04b716 has_sql=true
2025-12-31T11:38:02.007043Z  INFO start: No L3 CF snapshot found - filter will be built on warmup has_sql=true
2025-12-31T11:38:02.007191Z  INFO start: Connecting to Redis (L2 - cache)... url=redis://localhost:6379 prefix=Some("sync:") has_sql=true
2025-12-31T11:38:02.010023Z  INFO start: Redis (L2) connected with merkle shadow tree has_sql=true has_redis=true
2025-12-31T11:38:02.011196Z  INFO start: Redis merkle tree is empty - will be populated on writes has_sql=true has_redis=true
2025-12-31T11:38:02.011303Z  INFO start: Sync engine ready (trust-verified startup complete) has_sql=true has_redis=true
   âœ… Engine ready! State: Ready

ğŸ“ Creating 5 sample entries...
   â±ï¸  Timing each .await() to showcase L1 cache speed
   â””â”€ Submitted: user.alice â†’ {"name":"Alice","role":"admin"} (174.958Âµs)
   â””â”€ Submitted: user.bob â†’ {"name":"Bob","role":"user"} (94.333Âµs)
   â””â”€ Submitted: user.carol â†’ {"name":"Carol","role":"user"} (87.875Âµs)
   â””â”€ Submitted: config.app â†’ {"theme":"dark","version":"2.0"} (83.917Âµs)
   â””â”€ Submitted: stats.daily â†’ {"latency_p99":12,"requests":42000} (91.166Âµs)
   âš¡ Submit avg: 106.449Âµs (L1 memory write, non-blocking)

â³ Flushing to backends... (waiting 100ms for async writes)
2025-12-31T11:38:02.075267Z  INFO Batch flush complete l2_success=5 l2_errors=0 l3_success=5 wal_fallback=0 groups=1 flush_ms=62 reason=Manual
   âœ… Flush complete!

ğŸ” Checking existence...
   â””â”€ contains_fast('user.alice'): true
   â””â”€ contains('user.alice'): true
   â””â”€ contains('user.nobody'): false

ğŸ“– Fetching entries back (with timing)...
   â±ï¸  These should hit L1 cache (microseconds!)
   â””â”€ user.alice (v1) â†’ {"name":"Alice","role":"admin"} (163.875Âµs)
   â””â”€ user.bob (v1) â†’ {"name":"Bob","role":"user"} (40.125Âµs)
   â””â”€ user.carol (v1) â†’ {"name":"Carol","role":"user"} (29.375Âµs)
   â””â”€ config.app (v1) â†’ {"theme":"dark","version":"2.0"} (28Âµs)
   â””â”€ stats.daily (v1) â†’ {"latency_p99":12,"requests":42000} (26.25Âµs)
   âš¡ Get avg: 57.525Âµs (L1 cache hit)

ğŸ“Š Engine Metrics:
   â”Œâ”€ L1 Cache (Memory)
   â”‚  â””â”€ Entries: 5
   â”‚  â””â”€ Size: 1725 bytes
   â”‚  â””â”€ Pressure: 0.0%
   â”œâ”€ L3 Cuckoo Filter (before verify)
   â”‚  â””â”€ Entries: 5/100000
   â”‚  â””â”€ Trust: Untrusted
   â”œâ”€ Merkle Trees
   â”‚  â””â”€ Redis (L2): c3d298dd23421256acc1a20ff6cc9ef1eb6ed5d6dd9840c8403353c4a54d56fe
   â”‚  â””â”€ SQL (L3):   c3d298dd23421256acc1a20ff6cc9ef1eb6ed5d6dd9840c8403353c4a54d56fe
   â”‚  â””â”€ âœ… Roots match! Data is in sync.

ğŸ” Verifying L3 filter against SQL merkle...
2025-12-31T11:38:02.194618Z  INFO Verifying L3 filter against SQL merkle root sql_root=c3d298dd23421256acc1a20ff6cc9ef1eb6ed5d6dd9840c8403353c4a54d56fe
2025-12-31T11:38:02.194644Z  INFO Marking cuckoo filter as trusted entries=5
   â””â”€ Verified: true â†’ Trust: Trusted

ğŸ“ Item Status:
   â””â”€ user.alice: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ user.bob: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ user.carol: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ config.app: Synced { in_l1: true, in_l2: true, in_l3: true }
   â””â”€ stats.daily: Synced { in_l1: true, in_l2: true, in_l3: true }

ğŸ“ˆ Raw Metrics (OTEL export format):
   â”Œâ”€ Counters (cumulative)
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L1} = 156
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L2} = 156
   â”‚  â””â”€ sync_engine_bytes_written_total{tier=L3} = 156
   â”‚  â””â”€ sync_engine_items_written_total{tier=L2} = 5
   â”‚  â””â”€ sync_engine_items_written_total{tier=L3} = 5
   â”‚  â””â”€ sync_engine_merkle_operations_total{store=redis,operation=batch_update,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L1,operation=submit,status=success} = 5
   â”‚  â””â”€ sync_engine_operations_total{tier=L2,operation=batch_write,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L3,operation=batch_write,status=success} = 1
   â”‚  â””â”€ sync_engine_operations_total{tier=L1,operation=get,status=hit} = 5
   â”œâ”€ Gauges (current value)
   â”‚  â””â”€ sync_engine_backend_healthy{backend=mysql} = 1.00
   â”‚  â””â”€ sync_engine_backend_healthy{backend=redis} = 1.00
   â”‚  â””â”€ sync_engine_backpressure_level = 0.00
   â”‚  â””â”€ sync_engine_cuckoo_filter_entries{filter=L3} = 5.00
   â”‚  â””â”€ sync_engine_cuckoo_filter_load{filter=L3} = 0.00
   â”‚  â””â”€ sync_engine_l1_cache_bytes = 1725.00
   â”‚  â””â”€ sync_engine_l1_cache_items = 5.00
   â”‚  â””â”€ sync_engine_memory_pressure = 0.00
   â””â”€ Histograms (distributions)
   â”‚  â””â”€ sync_engine_batch_bytes{tier=L2}
   â”‚     count=1 sum=156.0000 avg=156.0000 min=156.0000 max=156.0000
   â”‚  â””â”€ sync_engine_batch_bytes{tier=L3}
   â”‚     count=1 sum=156.0000 avg=156.0000 min=156.0000 max=156.0000
   â”‚  â””â”€ sync_engine_batch_size{tier=L2}
   â”‚     count=1 sum=5.0000 avg=5.0000 min=5.0000 max=5.0000
   â”‚  â””â”€ sync_engine_batch_size{tier=L3}
   â”‚     count=1 sum=5.0000 avg=5.0000 min=5.0000 max=5.0000
   â”‚  â””â”€ sync_engine_flush_seconds
   â”‚     count=1 sum=0.0628 avg=0.0628 min=0.0628 max=0.0628
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L1,operation=submit}
   â”‚     count=5 sum=0.0002 avg=0.0000 min=0.0000 max=0.0001
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L2,operation=batch_write}
   â”‚     count=1 sum=0.0011 avg=0.0011 min=0.0011 max=0.0011
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L3,operation=batch_write}
   â”‚     count=1 sum=0.0118 avg=0.0118 min=0.0118 max=0.0118
   â”‚  â””â”€ sync_engine_operation_seconds{tier=L1,operation=get}
   â”‚     count=5 sum=0.0001 avg=0.0000 min=0.0000 max=0.0001
   â”‚  â””â”€ sync_engine_startup_seconds{phase=wal_init}
   â”‚     count=1 sum=0.0078 avg=0.0078 min=0.0078 max=0.0078
   â”‚  â””â”€ sync_engine_startup_seconds{phase=sql_connect}
   â”‚     count=1 sum=0.1168 avg=0.1168 min=0.1168 max=0.1168
   â”‚  â””â”€ sync_engine_startup_seconds{phase=cf_restore}
   â”‚     count=1 sum=0.0006 avg=0.0006 min=0.0006 max=0.0006
   â”‚  â””â”€ sync_engine_startup_seconds{phase=redis_connect}
   â”‚     count=1 sum=0.0028 avg=0.0028 min=0.0028 max=0.0028
   â”‚  â””â”€ sync_engine_startup_seconds{phase=redis_sync}
   â”‚     count=1 sum=0.0012 avg=0.0012 min=0.0012 max=0.0012
   â”‚  â””â”€ sync_engine_startup_total_seconds
   â”‚     count=1 sum=0.1363 avg=0.1363 min=0.1363 max=0.1363

ğŸ›‘ Shutting down...
2025-12-31T11:38:02.201207Z  INFO shutdown: Initiating sync engine shutdown...
2025-12-31T11:38:02.219681Z  INFO shutdown: Filter state saved filter_id="l3" entry_count=5 bytes=131108
2025-12-31T11:38:02.219716Z  INFO shutdown: Cuckoo filter snapshot saved (L3 only) reason="shutdown" inserts_since_last=5 l3_entries=5 merkle_root=c3d298dd23421256acc1a20ff6cc9ef1eb6ed5d6dd9840c8403353c4a54d56fe
2025-12-31T11:38:02.219759Z  INFO shutdown: Sync engine shutdown complete
   âœ… Shutdown complete! State: ShuttingDown

ğŸ§¹ Cleaning up WAL file...
   â””â”€ Removed: ./sync_engine_wal.db
   âœ… WAL cleanup complete!

ğŸ’¡ Data remains in Redis/MySQL - inspect with:
   â””â”€ Redis:  redis-cli JSON.GET sync:user.alice '$.payload'
   â””â”€ MySQL:  SELECT id, payload FROM sync_items;
   â””â”€ Query:  SELECT * FROM sync_items WHERE JSON_EXTRACT(payload, '$.name') = 'Alice';
   â””â”€ UIs:    http://localhost:5540 (RedisInsight)
              http://localhost:8080 (Adminer)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Example complete!                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•